export class GitHubApiClient{constructor(e){this.username=e,this.baseURL="https://api.github.com",this.cachePrefix="github-api",this.cacheTimeout=3e5,this.rateLimitRemaining=null,this.rateLimitReset=null,this.requestConfig={headers:{Accept:"application/vnd.github.v3+json","User-Agent":"Portfolio-Site/1.0"}}}async getRepositories(e=10){const t=`${this.cachePrefix}-repos-${this.username}`;try{const s=this.getCachedData(t);if(s)return console.log("Using cached repository data"),s.slice(0,e);console.log("Fetching repositories from GitHub API");const a=await this.fetchRepositories();return this.setCachedData(t,a),a.slice(0,e)}catch(s){console.error("Error fetching repositories:",s);const a=this.getStaleCache(t);if(a)return console.log("Using stale cache data as fallback"),a.slice(0,e);throw s}}async fetchRepositories(){const e=`${this.baseURL}/users/${this.username}/repos`,t=new URLSearchParams({sort:"updated",direction:"desc",per_page:"20",type:"owner"}),s=await this.makeRequest(`${e}?${t}`),a=await s.json();return this.processRepositories(a)}processRepositories(e){return e.filter(e=>!e.fork&&!e.archived).map(e=>({id:e.id,name:e.name,description:e.description,html_url:e.html_url,language:e.language,topics:e.topics||[],stargazers_count:e.stargazers_count,forks_count:e.forks_count,updated_at:e.updated_at,created_at:e.created_at,size:e.size})).sort((e,t)=>e.stargazers_count!==t.stargazers_count?t.stargazers_count-e.stargazers_count:new Date(t.updated_at)-new Date(e.updated_at))}async getUserStats(){const e=`${this.cachePrefix}-user-${this.username}`;try{const t=this.getCachedData(e);if(t)return t;const s=`${this.baseURL}/users/${this.username}`,a=await this.makeRequest(s),r=await a.json(),i={public_repos:r.public_repos,followers:r.followers,following:r.following,created_at:r.created_at,updated_at:r.updated_at,bio:r.bio,location:r.location,blog:r.blog};return this.setCachedData(e,i),i}catch(e){return console.error("Error fetching user stats:",e),{public_repos:0,followers:0,following:0,created_at:null,updated_at:null}}}async makeRequest(e){if(this.isRateLimited())throw new Error("Rate limit exceeded. Please try again later.");const t=new AbortController,s=setTimeout(()=>t.abort(),1e4);try{const a=await fetch(e,{...this.requestConfig,signal:t.signal});if(clearTimeout(s),this.updateRateLimitInfo(a),!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return a}catch(e){if(clearTimeout(s),"AbortError"===e.name)throw new Error("Request timeout");throw e}}updateRateLimitInfo(e){const t=e.headers.get("X-RateLimit-Remaining"),s=e.headers.get("X-RateLimit-Reset");null!==t&&(this.rateLimitRemaining=parseInt(t,10)),null!==s&&(this.rateLimitReset=1e3*parseInt(s,10)),console.log(`Rate limit: ${this.rateLimitRemaining} requests remaining`)}isRateLimited(){if(null===this.rateLimitRemaining||null===this.rateLimitReset)return!1;return Date.now()>this.rateLimitReset?(this.rateLimitRemaining=null,this.rateLimitReset=null,!1):this.rateLimitRemaining<=0}getCachedData(e){try{const t=sessionStorage.getItem(e);if(!t)return null;const s=JSON.parse(t);return Date.now()-s.timestamp<this.cacheTimeout?s.value:(sessionStorage.removeItem(e),null)}catch(e){return console.warn("Error reading from cache:",e),null}}getStaleCache(e){try{const t=sessionStorage.getItem(e);if(!t)return null;return JSON.parse(t).value}catch(e){return console.warn("Error reading stale cache:",e),null}}setCachedData(e,t){const s={value:t,timestamp:Date.now()};try{sessionStorage.setItem(e,JSON.stringify(s))}catch(t){if(console.warn("Error writing to cache:",t),"QuotaExceededError"===t.name){this.clearOldCache();try{sessionStorage.setItem(e,JSON.stringify(s))}catch(e){console.warn("Failed to cache data after cleanup:",e)}}}}clearOldCache(){try{const e=Object.keys(sessionStorage),t=e.filter(e=>e.startsWith(this.cachePrefix)).map(e=>{try{return{key:e,timestamp:JSON.parse(sessionStorage.getItem(e)).timestamp||0}}catch{return{key:e,timestamp:0}}}).sort((e,t)=>e.timestamp-t.timestamp),s=t.slice(0,Math.ceil(t.length/2));s.forEach(e=>{sessionStorage.removeItem(e.key)}),console.log(`Cleared ${s.length} old cache entries`)}catch(e){console.warn("Error clearing old cache:",e)}}isCacheStale(){const e=`${this.cachePrefix}-repos-${this.username}`;return!this.getCachedData(e)}clearCache(){try{const e=Object.keys(sessionStorage);e.filter(e=>e.startsWith(this.cachePrefix)&&e.includes(this.username)).forEach(e=>{sessionStorage.removeItem(e)}),console.log(`Cleared cache for user: ${this.username}`)}catch(e){console.warn("Error clearing cache:",e)}}getCacheStats(){try{const e=Object.keys(sessionStorage).filter(e=>e.startsWith(this.cachePrefix));let t=0,s=0,a=0;return e.forEach(e=>{const r=sessionStorage.getItem(e);t+=r.length;try{const e=JSON.parse(r);Date.now()-e.timestamp<this.cacheTimeout?s++:a++}catch{a++}}),{totalEntries:e.length,validEntries:s,expiredEntries:a,totalSize:t,averageSize:e.length>0?Math.round(t/e.length):0}}catch(e){return console.warn("Error getting cache stats:",e),null}}}