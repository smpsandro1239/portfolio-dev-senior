name: Build and Deploy Portfolio

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: npm
        
    - name: Verify Node.js and npm versions
      run: |
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        echo "ESLint version: $(npx eslint --version)"
        
    - name: Install dependencies
      run: npm ci

    # --- ValidaÃ§Ãµes de cÃ³digo (usam os scripts npm) ---
    - name: Validate HTML
      run: npm run lint:html
        
    - name: Validate CSS
      run: npm run lint:css
        
    - name: Validate JavaScript (ESLint v9)
      run: npm run lint:js
      
    # Backup: Direct ESLint execution (if npm script fails)
    - name: Validate JavaScript (Direct ESLint - Backup)
      if: failure()
      run: npx eslint src/js/

    # --- Lighthouse CI ---
    - name: Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true

    # --- Build dos assets de produÃ§Ã£o ---
    - name: Build production assets
      run: |
        mkdir -p docs
        cp src/index.html docs/
        
        mkdir -p docs/css
        npx csso-cli src/css/main.css -o docs/css/main.css
        
        mkdir -p docs/js
        for js_file in src/js/*.js; do
          if [ -f "$js_file" ]; then
            filename=$(basename "$js_file")
            npx terser "$js_file" --compress --mangle --output "docs/js/$filename"
          fi
        done
        
        if [ -d "src/img" ]; then
          cp -r src/img docs/
        fi
        
        touch docs/.nojekyll

    # --- VerificaÃ§Ã£o de budget de performance ---
    - name: Performance Budget Check
      id: perf-check
      run: |
        echo "Checking performance budget..."
        
        css_size=$(stat -c%s docs/css/main.css)
        if [ $css_size -gt 51200 ]; then
          echo "âŒ CSS file too large: ${css_size} bytes (limit: 50KB)"
          exit 1
        else
          echo "âœ… CSS size OK: ${css_size} bytes"
        fi
        
        js_total=0
        for file in docs/js/*.js; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            js_total=$((js_total + size))
          fi
        done
        
        if [ $js_total -gt 102400 ]; then
          echo "âŒ JavaScript files too large: ${js_total} bytes (limit: 100KB)"
          exit 1
        else
          echo "âœ… JavaScript size OK: ${js_total} bytes"
        fi
        
        echo "css_size=$css_size" >> $GITHUB_OUTPUT
        echo "js_total=$js_total" >> $GITHUB_OUTPUT

    # --- Teste de acessibilidade real com axe-core ---
    - name: Accessibility Test
      run: |
        npx serve -s docs -l 8080 &
        sleep 3
        npx @axe-core/cli http://localhost:8080

    # --- Deploy para GitHub Pages (sÃ³ na main) ---
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs

    # --- RelatÃ³rio final claro e fiÃ¡vel ---
    - name: Generate Build Report
      if: always()
      run: |
        {
          echo "## Build Report ðŸ“Š"
          echo ""
          echo "### File Sizes"
          echo "| File | Size (bytes) |"
          echo "|------|--------------|"
          
          for file in docs/css/*.css docs/js/*.js; do
            if [ -f "$file" ]; then
              size=$(stat -c%s "$file")
              filename=$(basename "$file")
              echo "| $filename | $size |"
            fi
          done
          
          echo ""
          echo "### Validation Results"
          echo "- âœ… HTML validation passed"
          echo "- âœ… CSS validation passed"
          echo "- âœ… JavaScript validation passed"
          echo "- âœ… Performance budget met"
          echo "- âœ… Accessibility test completed"
          
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "- âœ… Deployed to GitHub Pages"
          fi
          
          echo ""
          echo "> Report generated on $(date -u '+%Y-%m-%d at %H:%M UTC')"
        } >> $GITHUB_STEP_SUMMARY